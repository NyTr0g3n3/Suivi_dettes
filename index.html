<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de Dettes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        #empty-state {
            text-align: center;
            padding: 50px 20px;
        }
        #empty-state .icon {
            font-size: 5rem;
            color: #d1d5db;
        }
        #empty-state p {
            margin-top: 1rem;
            font-size: 1.125rem;
            color: #6b7280;
        }
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Vue de Connexion -->
    <div id="login-view" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="text-center p-8 bg-white shadow-lg rounded-xl max-w-sm w-full">
            <i class="fas fa-wallet fa-3x text-blue-600 mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Suivi de Dettes</h1>
            <p class="text-gray-500 mb-6">Connectez-vous pour synchroniser vos données sur tous vos appareils.</p>
            <button id="sign-in-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50 transition flex items-center justify-center shadow-sm">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.601-3.417-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C41.38,36.128,44,30.638,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Se connecter avec Google
            </button>
        </div>
    </div>

    <!-- Conteneur principal de l'application -->
    <div id="app-container" class="hidden">
        <div id="app" class="max-w-4xl mx-auto md:p-4">
            
            <!-- Vue principale (Dashboard) -->
            <main id="dashboard-view">
                <header class="bg-white shadow-sm sticky top-0 z-10 p-4 md:rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div>
                             <h1 class="text-2xl font-bold text-gray-900">Mes Prêts</h1>
                             <p id="user-info" class="text-xs text-gray-500 truncate"></p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="manage-contacts-btn" class="text-gray-600 hover:text-blue-600"><i class="fas fa-users fa-lg"></i></button>
                            <button id="sign-out-btn" class="text-gray-600 hover:text-red-600"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                        </div>
                    </div>
                    <div id="dashboard-summary" class="mt-4 p-4 bg-blue-50 rounded-lg grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-sm text-blue-700">Total prêté</p>
                            <p id="total-lent" class="text-2xl md:text-3xl font-bold text-blue-900">0,00 €</p>
                        </div>
                        <div>
                            <p class="text-sm text-blue-700">Débiteurs</p>
                            <p id="debtors-count" class="text-2xl md:text-3xl font-bold text-blue-900">0</p>
                        </div>
                    </div>
                </header>
    
                <div id="contact-list-container" class="p-4">
                    <div id="contact-list" class="space-y-3"></div>
                    <div id="empty-state" class="hidden">
                        <div class="icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <p>Aucun prêt en cours. Appuyez sur '+' pour commencer.</p>
                    </div>
                </div>
            </main>
    
            <!-- Vue Détails du Contact -->
            <section id="contact-details-view" class="hidden p-4">
                <header class="flex items-center mb-4">
                    <button id="back-to-dashboard-btn" class="mr-4 text-gray-600 hover:text-blue-600"><i class="fas fa-arrow-left fa-lg"></i></button>
                    <div>
                        <h2 id="details-contact-name" class="text-2xl font-bold"></h2>
                        <p class="text-gray-500">Total dû : <span id="details-total-due" class="font-semibold"></span></p>
                    </div>
                </header>
                <div class="flex space-x-2 mb-4">
                    <button id="add-global-repayment-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition"><i class="fas fa-hand-holding-usd mr-2"></i>Encaisser</button>
                    <button id="export-csv-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition"><i class="fas fa-file-csv mr-2"></i>Exporter</button>
                </div>
                <div id="transaction-history" class="space-y-3"></div>
            </section>
    
            <!-- Bouton d'action flottant -->
            <button id="add-transaction-btn" class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-blue-700 transition transform hover:scale-110">
                <i class="fas fa-plus fa-2x"></i>
            </button>
        </div>
    </div>
    
    <!-- Modales -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 id="modal-title" class="text-xl font-bold mb-4">Nouveau Prêt</h2>
            <form id="transaction-form">
                <input type="hidden" id="transaction-id">
                <div class="mb-4">
                    <label for="contact-select" class="block text-sm font-medium text-gray-700">Pour qui ?</label>
                    <select id="contact-select" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700">Montant (€)</label>
                        <input type="number" id="amount" step="0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="25,50">
                    </div>
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="date" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <input type="text" id="description" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Courses, restaurant...">
                </div>
                <div class="mb-4">
                    <label for="category" class="block text-sm font-medium text-gray-700">Catégorie</label>
                    <select id="category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option>Cash</option> <option>Courses</option> <option>Restaurant</option> <option>Transport</option> <option>Loisirs</option> <option>Autre</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-transaction-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Annuler</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>
    <div id="contacts-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">Gérer les Contacts</h2>
            <form id="add-contact-form" class="flex items-center mb-4">
                <input type="text" id="new-contact-name" class="flex-grow border-gray-300 rounded-l-md shadow-sm" placeholder="Nom du contact" required>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700"><i class="fas fa-plus"></i></button>
            </form>
            <div id="all-contacts-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
             <div class="flex justify-end mt-4">
                <button type="button" id="close-contacts-modal-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Fermer</button>
            </div>
        </div>
    </div>
    <div id="repayment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">Remboursement</h2>
            <form id="repayment-form">
                <input type="hidden" id="repayment-transaction-id">
                <p id="repayment-context-text" class="mb-2">Montant dû : <span id="repayment-due-amount" class="font-bold"></span></p>
                <div class="mb-4">
                    <label for="repayment-amount" class="block text-sm font-medium text-gray-700">Montant remboursé (€)</label>
                    <input type="number" id="repayment-amount" step="0.01" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-repayment-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Annuler</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Confirmer</button>
                </div>
            </form>
        </div>
    </div>
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <input type="hidden" id="delete-target-id"><input type="hidden" id="delete-target-type">
            <p id="delete-confirm-message" class="text-lg mb-4">Êtes-vous sûr ?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400">Annuler</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Supprimer</button>
            </div>
        </div>
    </div>

<script type="module">
    // Importations Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, addDoc, doc, deleteDoc, updateDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Configuration Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyCEEf5fYsGEpF3sSmKnKdUsyAVBmBq1CII",
        authDomain: "suivi-dettes.firebaseapp.com",
        projectId: "suivi-dettes",
        storageBucket: "suivi-dettes.firebasestorage.app",
        messagingSenderId: "688459270431",
        appId: "1:688459270431:web:a7d7a9691a49984bf9c82a",
        measurementId: "G-LCT4B4L53Q"
    };
    
    // --- Initialisation Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- Variables globales ---
    let currentUserId = null;
    let contacts = [];
    let transactions = [];
    let contactsUnsubscribe = () => {};
    let transactionsUnsubscribe = () => {};

    // --- Sélecteurs d'éléments DOM ---
    const loginView = document.getElementById('login-view');
    const appContainer = document.getElementById('app-container');
    const signInBtn = document.getElementById('sign-in-btn');
    const signOutBtn = document.getElementById('sign-out-btn');
    const userInfo = document.getElementById('user-info');
    
    const dashboardView = document.getElementById('dashboard-view');
    const contactDetailsView = document.getElementById('contact-details-view');
    const addTransactionBtn = document.getElementById('add-transaction-btn');
    const transactionModal = document.getElementById('transaction-modal');
    const contactsModal = document.getElementById('contacts-modal');
    const repaymentModal = document.getElementById('repayment-modal');
    const deleteConfirmModal = document.getElementById('delete-confirm-modal');

    // --- Système de notifications ---
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-in forwards';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }

    // --- Authentification ---
    onAuthStateChanged(auth, (user) => {
        contactsUnsubscribe();
        transactionsUnsubscribe();

        if (user) {
            currentUserId = user.uid;
            userInfo.textContent = user.displayName || user.email;
            
            loginView.classList.add('hidden');
            appContainer.classList.remove('hidden');
            
            loadData();
        } else {
            currentUserId = null;
            contacts = [];
            transactions = [];
            renderDashboard();
            
            loginView.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
    });

    async function signInWithGoogle() {
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
            showToast('Connexion réussie !');
        } catch (error) {
            console.error("Erreur de connexion avec Google:", error);
            showToast('Erreur de connexion. Veuillez réessayer.', 'error');
        }
    }

    async function signOutUser() {
        try {
            await signOut(auth);
            showToast('Déconnexion réussie');
        } catch (error) {
            console.error("Erreur de déconnexion:", error);
            showToast('Erreur lors de la déconnexion', 'error');
        }
    }

    signInBtn.addEventListener('click', signInWithGoogle);
    signOutBtn.addEventListener('click', signOutUser);
    
    // --- Chargement des données ---
    function loadData() {
        if (!currentUserId) return;
        
        const contactsRef = collection(db, 'users', currentUserId, 'contacts');
        contactsUnsubscribe = onSnapshot(contactsRef, (snapshot) => {
            contacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAllContactsList();
            updateContactDropdown();
            renderDashboard();
        }, (error) => {
            console.error("Erreur lors du chargement des contacts:", error);
            showToast('Erreur de chargement des contacts', 'error');
        });

        const transactionsRef = collection(db, 'users', currentUserId, 'transactions');
        transactionsUnsubscribe = onSnapshot(transactionsRef, (snapshot) => {
            transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderDashboard();
            const currentContactId = contactDetailsView.dataset.currentContactId;
            if (!contactDetailsView.classList.contains('hidden') && currentContactId) {
                renderContactDetails(currentContactId);
            }
        }, (error) => {
            console.error("Erreur lors du chargement des transactions:", error);
            showToast('Erreur de chargement des transactions', 'error');
        });
    }

    // --- Fonctions Utilitaires et Rendu ---
    function formatCurrency(value) {
        return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(value);
    }

    function renderDashboard() {
        const contactList = document.getElementById('contact-list');
        const emptyState = document.getElementById('empty-state');
        const debtsByContact = {};
        let totalLent = 0;

        transactions.forEach(t => {
            if (!t.isPaid) {
                const due = t.amount - (t.paidAmount || 0);
                if (due > 0.001) {
                    debtsByContact[t.contactId] = (debtsByContact[t.contactId] || 0) + due;
                    totalLent += due;
                }
            }
        });

        document.getElementById('total-lent').textContent = formatCurrency(totalLent);
        const debtorsCount = Object.keys(debtsByContact).length;
        document.getElementById('debtors-count').textContent = debtorsCount;
        contactList.innerHTML = '';
        
        if (debtorsCount === 0) {
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
        }

        const sortedContactIds = Object.keys(debtsByContact).sort((a, b) => debtsByContact[b] - debtsByContact[a]);

        for (const contactId of sortedContactIds) {
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                let lastRepaymentHTML = '';
                if (contact.lastRepaymentDate) {
                    const date = new Date(contact.lastRepaymentDate);
                    const formattedDate = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    lastRepaymentHTML = `<p class="text-xs text-gray-400 mt-1">Dernier remb. le ${formattedDate}</p>`;
                }

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-100 transition';
                card.dataset.contactId = contactId;
                card.innerHTML = `
                    <div>
                        <p class="font-semibold text-lg">${contact.name}</p>
                        ${lastRepaymentHTML || '<p class="text-xs text-gray-400 mt-1">Aucun remboursement</p>'}
                    </div>
                    <p class="font-bold text-xl text-red-600">${formatCurrency(debtsByContact[contactId])}</p>
                `;
                card.addEventListener('click', () => showContactDetails(contactId));
                contactList.appendChild(card);
            }
        }
    }
    
    function renderContactDetails(contactId) {
        const contact = contacts.find(c => c.id === contactId);
        if (!contact) return;

        document.getElementById('details-contact-name').textContent = contact.name;
        
        const contactTransactions = transactions
            .filter(t => t.contactId === contactId)
            .sort((a, b) => new Date(b.date) - new Date(a.date));

        const totalDue = contactTransactions.reduce((acc, t) => {
             const due = t.amount - (t.paidAmount || 0);
             return acc + (due > 0 ? due : 0);
        }, 0);
        document.getElementById('details-total-due').textContent = formatCurrency(totalDue);
        
        const historyContainer = document.getElementById('transaction-history');
        historyContainer.innerHTML = '';

        if (contactTransactions.length === 0) {
            historyContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">Aucune transaction avec ${contact.name}.</p>`;
            return;
        }

        contactTransactions.forEach(t => {
            const isFullyPaid = t.isPaid || (t.amount - (t.paidAmount || 0) < 0.01);
            const due = t.amount - (t.paidAmount || 0);
            const card = document.createElement('div');
            card.className = `bg-white p-3 rounded-lg shadow-sm border-l-4 ${isFullyPaid ? 'border-green-500' : 'border-red-500'}`;
            const formattedDate = new Date(t.date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-semibold">${t.description} <span class="text-sm font-normal text-gray-400">(${t.category})</span></p>
                        <p class="text-sm text-gray-500">${formattedDate}</p>
                    </div>
                    <div class="text-right">
                         <p class="font-bold text-lg ${isFullyPaid ? 'text-gray-500 line-through' : 'text-gray-800'}">${formatCurrency(t.amount)}</p>
                         ${!isFullyPaid && (t.paidAmount || 0) > 0 ? `<p class="text-xs text-yellow-600">Partiel: ${formatCurrency(t.paidAmount)}</p>` : ''}
                         ${!isFullyPaid ? `<p class="text-xs text-red-600">Dû: ${formatCurrency(due)}</p>` : `<p class="text-xs text-green-600">Remboursé</p>`}
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-2">
                    ${!isFullyPaid ? `<button data-id="${t.id}" class="pay-btn bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full hover:bg-green-200">Rembourser</button>` : ''}
                    <button data-id="${t.id}" class="edit-transaction-btn text-gray-400 hover:text-blue-500"><i class="fas fa-pen"></i></button>
                    <button data-id="${t.id}" class="delete-transaction-btn text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </div>
            `;
            historyContainer.appendChild(card);
        });
    }
    
    function renderAllContactsList() {
        const listEl = document.getElementById('all-contacts-list');
        listEl.innerHTML = '';
        if (contacts.length === 0) {
             listEl.innerHTML = '<p class="text-gray-500 text-center">Aucun contact ajouté.</p>';
             return;
        }
        contacts.sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
            item.innerHTML = `<span>${c.name}</span><button data-id="${c.id}" class="delete-contact-btn text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>`;
            listEl.appendChild(item);
        });
    }
    
    function updateContactDropdown() {
        const select = document.getElementById('contact-select');
        select.innerHTML = '<option value="">Sélectionner un contact</option>';
        contacts.sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = c.name;
            select.appendChild(option);
        });
    }

    function showDashboard() {
        dashboardView.classList.remove('hidden');
        contactDetailsView.classList.add('hidden');
        contactDetailsView.dataset.currentContactId = '';
        addTransactionBtn.classList.remove('hidden');
    }

    function showContactDetails(contactId) {
        dashboardView.classList.add('hidden');
        contactDetailsView.classList.remove('hidden');
        addTransactionBtn.classList.add('hidden');
        contactDetailsView.dataset.currentContactId = contactId;
        renderContactDetails(contactId);
    }
    
    function openModal(modal) {
        modal.classList.remove('hidden');
        modal.classList.remove('modal-leave');
        modal.classList.add('modal-enter');
    }

    function closeModal(modal) {
        modal.classList.remove('modal-enter');
        modal.classList.add('modal-leave');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }
    
    // --- Logique Métier (Firestore) ---
    async function addContact(name) {
        if (!currentUserId || !name.trim()) return;
        try {
            await addDoc(collection(db, 'users', currentUserId, 'contacts'), { name: name.trim() });
            showToast('Contact ajouté avec succès');
        } catch (error) { 
            console.error("Erreur ajout contact:", error); 
            showToast('Erreur lors de l\'ajout du contact', 'error');
        }
    }

    async function deleteContact(contactId) {
        if (!currentUserId) return;
        try {
            const batch = writeBatch(db);
            const q = query(collection(db, 'users', currentUserId, 'transactions'), where("contactId", "==", contactId));
            const snapshot = await getDocs(q);
            snapshot.forEach(doc => { batch.delete(doc.ref); });
            batch.delete(doc(db, 'users', currentUserId, 'contacts', contactId));
            await batch.commit();
            if (contactDetailsView.dataset.currentContactId === contactId) showDashboard();
            showToast('Contact supprimé avec succès');
        } catch (error) { 
            console.error("Erreur suppression contact:", error); 
            showToast('Erreur lors de la suppression', 'error');
        }
    }
    
    async function saveTransaction(data) {
        if (!currentUserId) return;
        const transactionsRef = collection(db, 'users', currentUserId, 'transactions');
        try {
            if (data.id) {
                const docRef = doc(db, 'users', currentUserId, 'transactions', data.id);
                const existingTransaction = transactions.find(t=>t.id===data.id) || {};
                await updateDoc(docRef, {
                    contactId: data.contactId, 
                    amount: data.amount, 
                    description: data.description, 
                    category: data.category, 
                    date: data.date, 
                    isPaid: data.amount <= (existingTransaction.paidAmount || 0)
                });
                showToast('Transaction modifiée avec succès');
            } else {
                 await addDoc(transactionsRef, {
                    contactId: data.contactId, 
                    amount: data.amount, 
                    description: data.description, 
                    category: data.category, 
                    date: data.date, 
                    isPaid: false, 
                    paidAmount: 0
                });
                showToast('Transaction ajoutée avec succès');
            }
        } catch (error) { 
            console.error("Erreur sauvegarde transaction:", error); 
            showToast('Erreur lors de la sauvegarde', 'error');
        }
    }
    
    async function deleteTransaction(transactionId) {
        if (!currentUserId) return;
        try {
            await deleteDoc(doc(db, 'users', currentUserId, 'transactions', transactionId));
            showToast('Transaction supprimée avec succès');
        } catch (error) { 
            console.error("Erreur suppression transaction:", error); 
            showToast('Erreur lors de la suppression', 'error');
        }
    }

    async function saveRepayment(transactionId, amount) {
        if (!currentUserId || amount <= 0) return;
        const transaction = transactions.find(t => t.id === transactionId);
        if (!transaction) return;
        try {
            const newPaidAmount = (transaction.paidAmount || 0) + amount;
            await updateDoc(doc(db, 'users', currentUserId, 'transactions', transactionId), {
                paidAmount: newPaidAmount, 
                isPaid: newPaidAmount >= transaction.amount
            });
            await updateDoc(doc(db, 'users', currentUserId, 'contacts', transaction.contactId), { 
                lastRepaymentDate: new Date().toISOString() 
            });
            showToast('Remboursement enregistré avec succès');
        } catch (error) { 
            console.error("Erreur sauvegarde remboursement:", error); 
            showToast('Erreur lors du remboursement', 'error');
        }
    }
    
    async function saveGlobalRepayment(contactId, totalRepayment) {
        if (!currentUserId || totalRepayment <= 0) return;
        const batch = writeBatch(db);
        let remainingRepayment = totalRepayment;
        const unpaidTransactions = transactions
            .filter(t => t.contactId === contactId && !t.isPaid)
            .sort((a, b) => new Date(a.date) - new Date(b.date));

        for (const t of unpaidTransactions) {
            if (remainingRepayment <= 0) break;
            const due = t.amount - (t.paidAmount || 0);
            const docRef = doc(db, 'users', currentUserId, 'transactions', t.id);
            if (remainingRepayment >= due) {
                batch.update(docRef, { paidAmount: t.amount, isPaid: true });
                remainingRepayment -= due;
            } else {
                batch.update(docRef, { paidAmount: (t.paidAmount || 0) + remainingRepayment, isPaid: false });
                remainingRepayment = 0;
            }
        }
        try {
            await batch.commit();
            await updateDoc(doc(db, 'users', currentUserId, 'contacts', contactId), { 
                lastRepaymentDate: new Date().toISOString() 
            });
            showToast('Remboursement global enregistré avec succès');
        } catch (error) { 
            console.error("Erreur lors du remboursement global:", error); 
            showToast('Erreur lors du remboursement global', 'error');
        }
    }

    function exportToCSV(contactId) {
        const contact = contacts.find(c => c.id === contactId);
        if (!contact) return;
        const contactTransactions = transactions
            .filter(t => t.contactId === contactId)
            .sort((a, b) => new Date(a.date) - new Date(b.date));
        let csvContent = "data:text/csv;charset=utf-8,Date,Description,Catégorie,Montant,Montant Remboursé,Statut\r\n";
        contactTransactions.forEach(t => {
            const row = [
                new Date(t.date).toLocaleDateString('fr-FR'), 
                `"${t.description.replace(/"/g, '""')}"`, 
                t.category, 
                t.amount, 
                (t.paidAmount || 0), 
                t.isPaid ? "Remboursé" : "Dû"
            ].join(',');
            csvContent += row + "\r\n";
        });
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", `historique_${contact.name.replace(/ /g,'_')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Export CSV réussi');
    }
    
    // --- Event Listeners ---
    document.getElementById('back-to-dashboard-btn').addEventListener('click', showDashboard);
    
    addTransactionBtn.addEventListener('click', () => {
        document.getElementById('transaction-form').reset();
        document.getElementById('transaction-id').value = '';
        document.getElementById('modal-title').textContent = 'Nouveau Prêt';
        document.getElementById('date').valueAsDate = new Date();
        openModal(transactionModal);
    });
    
    document.getElementById('manage-contacts-btn').addEventListener('click', () => openModal(contactsModal));
    document.getElementById('cancel-transaction-btn').addEventListener('click', () => closeModal(transactionModal));
    
    document.getElementById('transaction-form').addEventListener('submit', (e) => {
        e.preventDefault();
        saveTransaction({
            id: document.getElementById('transaction-id').value,
            contactId: document.getElementById('contact-select').value,
            amount: parseFloat(document.getElementById('amount').value),
            description: document.getElementById('description').value,
            category: document.getElementById('category').value,
            date: document.getElementById('date').valueAsDate.toISOString()
        });
        closeModal(transactionModal);
    });
    
    document.getElementById('close-contacts-modal-btn').addEventListener('click', () => closeModal(contactsModal));
    
    document.getElementById('add-contact-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('new-contact-name');
        addContact(input.value);
        input.value = '';
    });
    
    document.getElementById('all-contacts-list').addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-contact-btn');
        if (deleteBtn) {
            const contact = contacts.find(c => c.id === deleteBtn.dataset.id);
            showDeleteConfirmation('contact', deleteBtn.dataset.id, `Supprimer ${contact.name} et toutes ses transactions ?`);
        }
    });
    
    document.getElementById('cancel-repayment-btn').addEventListener('click', () => closeModal(repaymentModal));
    
    document.getElementById('repayment-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const transactionId = document.getElementById('repayment-transaction-id').value;
        const amount = parseFloat(document.getElementById('repayment-amount').value);
        if (transactionId) {
            saveRepayment(transactionId, amount);
        } else {
            saveGlobalRepayment(contactDetailsView.dataset.currentContactId, amount);
        }
        closeModal(repaymentModal);
    });
    
    document.getElementById('transaction-history').addEventListener('click', (e) => {
        const payBtn = e.target.closest('.pay-btn');
        const deleteBtn = e.target.closest('.delete-transaction-btn');
        const editBtn = e.target.closest('.edit-transaction-btn');
        
        if (payBtn) {
            const transaction = transactions.find(t => t.id === payBtn.dataset.id);
            if (transaction) {
                const due = transaction.amount - (transaction.paidAmount || 0);
                document.getElementById('repayment-form').reset();
                document.getElementById('repayment-transaction-id').value = transaction.id;
                document.getElementById('repayment-due-amount').textContent = formatCurrency(due);
                document.getElementById('repayment-amount').value = due.toFixed(2);
                document.getElementById('repayment-amount').max = due.toFixed(2);
                document.getElementById('repayment-context-text').classList.remove('hidden');
                repaymentModal.querySelector('h2').textContent = 'Remboursement';
                openModal(repaymentModal);
            }
        }
        
        if (editBtn) {
            const t = transactions.find(t => t.id === editBtn.dataset.id);
            if(t) {
                document.getElementById('transaction-form').reset();
                document.getElementById('modal-title').textContent = 'Modifier la transaction';
                document.getElementById('transaction-id').value = t.id;
                document.getElementById('contact-select').value = t.contactId;
                document.getElementById('amount').value = t.amount;
                document.getElementById('description').value = t.description;
                document.getElementById('date').value = t.date.split('T')[0];
                document.getElementById('category').value = t.category;
                openModal(transactionModal);
            }
        }
        
        if (deleteBtn) {
            showDeleteConfirmation('transaction', deleteBtn.dataset.id, 'Supprimer cette transaction ?');
        }
    });
    
    function showDeleteConfirmation(type, id, message) {
        document.getElementById('delete-target-type').value = type;
        document.getElementById('delete-target-id').value = id;
        document.getElementById('delete-confirm-message').textContent = message;
        openModal(deleteConfirmModal);
    }
    
    document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal(deleteConfirmModal));
    
    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
        const type = document.getElementById('delete-target-type').value;
        const id = document.getElementById('delete-target-id').value;
        if (type === 'contact') await deleteContact(id);
        else if (type === 'transaction') await deleteTransaction(id);
        closeModal(deleteConfirmModal);
    });
    
    document.getElementById('add-global-repayment-btn').addEventListener('click', () => {
        const contactId = contactDetailsView.dataset.currentContactId;
        const contact = contacts.find(c => c.id === contactId);
        if (!contact) return;
        const totalDue = transactions
            .filter(t => t.contactId === contactId && !t.isPaid)
            .reduce((acc, t) => acc + (t.amount - (t.paidAmount || 0)), 0);
        document.getElementById('repayment-form').reset();
        document.getElementById('repayment-transaction-id').value = '';
        document.getElementById('repayment-context-text').classList.add('hidden');
        repaymentModal.querySelector('h2').textContent = `Encaisser pour ${contact.name}`;
        document.getElementById('repayment-amount').value = totalDue.toFixed(2);
        document.getElementById('repayment-amount').max = totalDue.toFixed(2);
        openModal(repaymentModal);
    });
    
    document.getElementById('export-csv-btn').addEventListener('click', () => {
        exportToCSV(contactDetailsView.dataset.currentContactId);
    });
</script>
</body>
</html>
